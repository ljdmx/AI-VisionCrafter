<div class="w-full h-full flex flex-col lg:grid lg:grid-cols-3 bg-gray-900 text-gray-100 font-sans overflow-hidden">
  <!-- Image Display Area -->
  <div class="flex-grow lg:col-span-2 w-full h-full flex items-center justify-center p-4 relative bg-black/20">
    <div class="w-full max-w-4xl aspect-video flex items-center justify-center relative">
       @if (generatedImageUrl()) {
          <img [src]="generatedImageUrl()" alt="AI 生成的图像" class="w-full h-full object-contain rounded-lg shadow-2xl">
           <button (click)="downloadImage()" class="absolute bottom-4 right-4 z-10 flex items-center gap-2 text-gray-200 bg-gray-900/60 hover:bg-gray-800/80 px-4 py-2 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.707a1 1 0 011.414 0L9 11.086V3a1 1 0 112 0v8.086l1.293-1.379a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" /></svg>
            下载图像
          </button>
      } @else {
        <div class="w-full h-full bg-gray-800/50 rounded-2xl flex items-center justify-center border border-gray-700">
          <div class="text-center text-gray-500 p-4">
             <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <h3 class="text-xl font-semibold text-gray-300">您的融合作品将在此呈现</h3>
            <p class="mt-1 text-sm">上传内容图和风格图，见证魔法的诞生。</p>
          </div>
        </div>
      }
      @if(isLoading()) {
          <div class="absolute inset-0 bg-gray-900/80 flex flex-col items-center justify-center z-20">
              <svg class="animate-spin h-10 w-10 text-purple-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="text-white font-medium">融合中，请稍候...</p>
          </div>
      }
    </div>
  </div>

  <!-- Controls Sidebar -->
  <div class="lg:col-span-1 w-full h-full bg-gray-800/50 border-l border-gray-700 flex flex-col overflow-hidden">
    <div class="p-4 border-b border-gray-700 flex-shrink-0">
      <h2 class="text-xl font-bold">图像融合</h2>
    </div>
    <div class="flex-grow p-4 flex flex-col gap-4 overflow-y-auto min-h-0">
      
      <div>
        <label for="content-upload" class="block text-sm font-medium text-gray-300 mb-2">1. 内容图</label>
        <div 
            (dragover)="$event.preventDefault(); isDraggingContent.set(true)" 
            (dragleave)="isDraggingContent.set(false)" 
            (drop)="onFileDrop($event, 'content')"
            class="w-full aspect-video bg-gray-900/50 flex items-center justify-center border-2 border-dashed rounded-lg transition-colors relative"
            [class.border-purple-500]="isDraggingContent()"
            [class.bg-gray-800/50]="isDraggingContent()"
            [class.border-gray-600]="!isDraggingContent()">
          @if(contentImageUrl()) {
            <img [src]="contentImageUrl()" alt="内容图预览" class="w-full h-full object-contain rounded-lg">
            <button (click)="clearContentImage()" class="absolute top-2 right-2 p-1.5 bg-gray-900/60 hover:bg-gray-800/80 rounded-full transition-colors" title="移除内容图">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
          } @else {
            <label for="content-upload" class="text-center p-4 text-gray-500 cursor-pointer w-full h-full flex flex-col items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
              <span class="text-sm font-medium">上传内容图</span>
              <span class="text-xs mt-1">拖放或点击上传 (最大 5MB)</span>
            </label>
          }
        </div>
        <input id="content-upload" type="file" class="sr-only" (change)="onFileSelected($event, 'content')" accept="image/png, image/jpeg">
      </div>

       <div>
        <label for="style-upload" class="block text-sm font-medium text-gray-300 mb-2">2. 风格图</label>
        <div 
            (dragover)="$event.preventDefault(); isDraggingStyle.set(true)" 
            (dragleave)="isDraggingStyle.set(false)" 
            (drop)="onFileDrop($event, 'style')"
            class="w-full aspect-video bg-gray-900/50 flex items-center justify-center border-2 border-dashed rounded-lg transition-colors relative"
            [class.border-purple-500]="isDraggingStyle()"
            [class.bg-gray-800/50]="isDraggingStyle()"
            [class.border-gray-600]="!isDraggingStyle()">
          @if(styleImageUrl()) {
            <img [src]="styleImageUrl()" alt="风格图预览" class="w-full h-full object-contain rounded-lg">
            <button (click)="clearStyleImage()" class="absolute top-2 right-2 p-1.5 bg-gray-900/60 hover:bg-gray-800/80 rounded-full transition-colors" title="移除风格图">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
          } @else {
            <label for="style-upload" class="text-center p-4 text-gray-500 cursor-pointer w-full h-full flex flex-col items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 21.75l-.648-1.188a2.25 2.25 0 01-1.423-1.423L13.125 18l1.188-.648a2.25 2.25 0 011.423-1.423L16.25 15l.648 1.188a2.25 2.25 0 011.423 1.423L19.375 18l-1.188.648a2.25 2.25 0 01-1.423 1.423z" /></svg>
              <span class="text-sm font-medium">上传风格图</span>
              <span class="text-xs mt-1">拖放或点击上传 (最大 5MB)</span>
            </label>
          }
        </div>
        <input id="style-upload" type="file" class="sr-only" (change)="onFileSelected($event, 'style')" accept="image/png, image/jpeg">
      </div>
      
       <div>
        <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">3. 额外指令 (可选)</label>
        <textarea 
          id="prompt" 
          rows="3" 
          class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-200 focus:ring-purple-500 focus:border-purple-500 transition" 
          placeholder="例如：背景改为夜晚, 增加一些星星"
          [value]="prompt()"
          (input)="updatePrompt($event, 'positive')"></textarea>
      </div>

       <div>
        <label for="negative-prompt" class="block text-sm font-medium text-gray-300 mb-2">4. 负向提示词 (可选)</label>
        <textarea 
          id="negative-prompt" 
          rows="2" 
          class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-200 focus:ring-purple-500 focus:border-purple-500 transition" 
          placeholder="例如：模糊, 画质差"
          [value]="negativePrompt()"
          (input)="updatePrompt($event, 'negative')"></textarea>
      </div>
      
       <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">5. 宽高比</label>
        <div class="grid grid-cols-3 gap-2 text-sm font-medium">
          <button (click)="aspectRatio.set('1:1')" [class.bg-purple-600]="aspectRatio() === '1:1'" [class.bg-gray-700]="aspectRatio() !== '1:1'" class="py-2 rounded-md hover:bg-purple-500 transition-colors">方形 (1:1)</button>
          <button (click)="aspectRatio.set('16:9')" [class.bg-purple-600]="aspectRatio() === '16:9'" [class.bg-gray-700]="aspectRatio() !== '16:9'" class="py-2 rounded-md hover:bg-purple-500 transition-colors">横向 (16:9)</button>
          <button (click)="aspectRatio.set('9:16')" [class.bg-purple-600]="aspectRatio() === '9:16'" [class.bg-gray-700]="aspectRatio() !== '9:16'" class="py-2 rounded-md hover:bg-purple-500 transition-colors">纵向 (9:16)</button>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">6. 专业参数</label>
        <div class="flex items-center gap-2">
            <input 
              type="number"
              placeholder="随机种子"
              [value]="seed() ?? ''"
              (input)="updateSeed($event)"
              class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-gray-200 focus:ring-purple-500 focus:border-purple-500 transition" />
            <button (click)="randomizeSeed()" class="p-2 bg-gray-700 hover:bg-purple-600/50 rounded-lg transition-colors" title="随机生成种子">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.5 6.002a3.5 3.5 0 00-4.333-3.415 3.5 3.5 0 00-2.83 5.586 3.5 3.5 0 005.47 2.427 3.502 3.502 0 001.693-4.598zm-1.125 2.86a2.5 2.5 0 01-3.8-2.203.5.5 0 00-.416-.583 2.5 2.5 0 013.416-3.416.5.5 0 00.583.416 2.5 2.5 0 012.203 3.8.5.5 0 00-.416.583 2.487 2.487 0 01-1.57.403z" />
                <path d="M5.5 13.528a3.5 3.5 0 014.333 3.415 3.5 3.5 0 01-5.47-2.427A3.5 3.5 0 012.67 9.919a3.5 3.5 0 011.693 4.598zm1.125-2.86a2.5 2.5 0 00-3.8 2.203.5.5 0 01.416.583 2.5 2.5 0 003.416 3.416.5.5 0 01-.583-.416 2.5 2.5 0 00-2.203-3.8.5.5 0 01.416-.583 2.487 2.487 0 001.335-.403z" />
              </svg>
            </button>
        </div>
      </div>

    </div>
    <div class="p-4 border-t border-gray-700 bg-gray-800 flex-shrink-0">
      <button 
        (click)="generateImage()" 
        [disabled]="!contentFile() || !styleFile() || isLoading()"
        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 hover:brightness-110 disabled:transform-none">
        @if (isLoading()) {
          <div class="flex items-center justify-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>融合中...</span>
          </div>
        } @else {
          <span class="flex items-center justify-center gap-2">🎨 融合图像</span>
        }
      </button>
    </div>
  </div>
</div>